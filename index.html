<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Pandemic Tracker</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous" />
    <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/blueimp-JavaScript-Templates/3.11.0/js/tmpl.min.js" integrity="sha256-XboZShAO7unfXE97NnKTadU7ISs3RtjNGlCGccyRxuA=" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/open-iconic/1.1.1/font/css/open-iconic-bootstrap.min.css" integrity="sha256-BJ/G+e+y7bQdrYkS2RBTyNfBHpA9IuGaPmf9htub5MQ=" crossorigin="anonymous" />
    <style id="lock-rules"></style>

    <script type="text/x-tmpl" id="discarded-card-tmpl">
      <div>{%= o.count %} x {%= o.name %}</div>
    </script>

    <script type="text/x-tmpl" id="shortstack-card-tmpl">
      <div>
        {%= o.name %}
        <button class="btn btn-outline-primary drawn-shortstack" value="{%= o.name %}" type="button">Drawn</button>
      </div>
    </script>

    <script type="text/x-tmpl" id="deck-card-tmpl">
      <div>
        {%= o.count %} x {%= o.name %}

        <div class="btn-group when-unlocked">
          <button class="btn btn-outline-primary add-another-to-deck" value="{%= o.name %}" type="button">Add</button>
          <button class="btn btn-outline-primary draw-card" value="{%= o.name %}" type="button">Draw</button>
          <button class="btn btn-outline-primary epidemic" value="{%= o.name %}" type="button">Epidemic</button>
        </div>

        <div class="btn-group when-locked">
          <button class="btn btn-outline-primary draw-card" value="{%= o.name %}" type="button">Draw</button>
          <button class="btn btn-outline-primary epidemic" value="{%= o.name %}" type="button">Epidemic</button>
        </div>
      </div>
    </script>

    <script type="text/javascript">
      function LockStatus() {
        this.name = "lockStatus";
        this.saveable = true;

        if (localStorage && localStorage.getItem("lockStatus") && localStorage.getItem("lockStatus") == "locked") {
          this.locked = true;
        } else {
          this.locked = false;
        }
      }

      LockStatus.prototype.dontSave = function() {
        this.saveable = false;
        return this;
      };

      LockStatus.prototype.export = function() {
        return this.name + ":" + this.locked;
      };

      LockStatus.prototype.import = function(value) {
        if (value == "true") {
          this.lock();
        } else {
          this.unlock();
        }
      };

      LockStatus.prototype.lock = function() {
        this.locked = true;

        if (localStorage && this.saveable) {
          localStorage.setItem("lockStatus", "locked");
        }

        return this;
      }

      LockStatus.prototype.unlock = function() {
        this.locked = false;

        if (localStorage && this.saveable) {
          localStorage.setItem("lockStatus", "unlocked");
        }

        return this;
      }

      LockStatus.prototype.redraw = function() {
        var sheet = $("#lock-rules")[0].sheet;

        if (sheet.rules.length > 0) {
          sheet.deleteRule(0);
        }

        if (this.locked) {
          sheet.insertRule(".when-unlocked { display: none; }", 0);
        } else {
          sheet.insertRule(".when-locked { display: none; }", 0);
        }
      }

      function CardStack(name, elementId, template, preserveOrder) {
        if (localStorage && localStorage.getItem(name)) {
          this.cards = localStorage.getItem(name).split(",");
        } else {
          this.cards = [];
        }

        this.name = name;
        this.elementId = elementId;
        this.template = template;
        this.preserveOrder = preserveOrder;
      }

      CardStack.prototype.export = function() {
        return this.name + ":" + this.cards.join(",");
      };

      CardStack.prototype.import = function(value) {
        this.reset();

        if (value && value != "") {
          this.addAll(value.split(","));
        }
      };

      CardStack.prototype.save = function() {
        if (!localStorage) {
          return;
        }

        localStorage.setItem(this.name, this.cards.join(","));
      };

      CardStack.prototype.add = function(name) {
        this.cards.push(name);
        this.save();
        return this;
      };

      CardStack.prototype.addAll = function(names) {
        this.cards = names.concat(this.cards);
        this.save();
      };

      CardStack.prototype.remove = function(name) {
        var index = this.cards.indexOf(name);

        if (index < 0) {
          throw new Error("Cannot find card to remove: " + name);
        }

        this.cards.splice(index, 1);
        this.save();
        return this;
      };

      CardStack.prototype.moveTo = function(otherStack) {
        otherStack.addAll(this.cards);
        this.reset();
        return this;
      };

      CardStack.prototype.reset = function() {
        this.cards = [];
        this.save();
      };

      CardStack.prototype.$container = function() {
        return $("#" + this.elementId);
      };

      CardStack.prototype.$cards = function() {
        return this.$container().find(".cards");
      };

      CardStack.prototype.redraw = function() {
        var $cards = this.$cards();
        $cards.empty();
        var template = this.template;

        if (this.preserveOrder) {
          this.each(function(card) {
            $cards.append(tmpl(template, { name: card }));
          });
        } else {
          this.eachSortedAndCounted(function(count, card) {
            $cards.append(tmpl(template, { count: count, name: card }));
          });
        }
      };

      CardStack.prototype.eachSortedAndCounted = function(fn) {
        var cards = this.cards.slice(0);
        cards.sort();

        while (cards.length > 0) {
          var size = 0;
          var card = cards[0];

          while (cards[0] == card) {
            size++;
            cards.splice(0, 1);
          }

          fn.call(null, size, card);
        }
      };

      CardStack.prototype.each = function(fn) {
        for (var i = 0; i < this.cards.length; i++) {
          fn(this.cards[i]);
        }
      };

      var discards = new CardStack("discards", "discarded-cards", "discarded-card-tmpl", false);
      var shortstack = new CardStack("shortstack", "shortstack-cards", "shortstack-card-tmpl", true);
      var deck = new CardStack("deck", "deck-cards", "deck-card-tmpl", false);
      var lockStatus = new LockStatus();

      function redrawAll() {
        discards.redraw();
        shortstack.redraw();
        deck.redraw();
        lockStatus.redraw();
      }

      $(function() {
        redrawAll();

        $("#lock-deck").click(function() {
          lockStatus.lock();
          lockStatus.redraw();
        });

        $("#unlock-deck").click(function() {
          lockStatus.unlock();
          lockStatus.redraw();
        });

        $("#reset-game").click(function() {
          if (confirm("Really reset the game?")) {
            discards.moveTo(deck);
            shortstack.moveTo(deck);
            redrawAll();
          }
        });

        $("#reset-everything").click(function() {
          if (confirm("Really reset EVERYTHING?")) {
            if (confirm("No.... really... all data will be gone... REALLY reset EVERYTHING?")) {
              discards.reset();
              shortstack.reset();
              deck.reset();
              lockStatus.unlock();
              redrawAll();
            }
          }
        });

        $("#add-to-deck").click(function() {
          if ($("#deck-card").val() == "") {
            return;
          }

          deck.add($("#deck-card").val()).redraw();
          $("#deck-card").val("");
        });

        $("#create-load-link").click(function() {
          var data = [discards.export(), shortstack.export(), deck.export(), new LockStatus().dontSave().lock().export()].join(";");
          var url = window.location.href.split("?")[0] + "?loadData=" + data;
          $("#load-link").html('<a href="' + url + '">Load from this link</a>');
        });

        $("#load-data").click(function() {
          var data = $("#game-data-to-load").val();

          if (data == "") {
            return;
          }

          if (!confirm("This will erase your current game and load the game... are you SURE?")) {
            return;
          }

          data = data.split(";");

          for (var i = 0; i < data.length; i++) {
            var item = data[i].split(":");

            switch (item[0]) {
              case discards.name:
                discards.import(item[1]);
                break;
              case shortstack.name:
                shortstack.import(item[1]);
                break;
              case deck.name:
                deck.import(item[1]);
                break;
              case lockStatus.name:
                lockStatus.import(item[1]);
                break;
            }
          }

          redrawAll();
          window.location.href = window.location.href.split("?")[0];
        });

        $(document).on("click", ".epidemic", function() {
          var card = $(this).val();
          deck.remove(card).redraw();
          discards.add(card);
          discards.moveTo(shortstack).redraw();
          shortstack.redraw();
        });

        $(document).on("click", ".draw-card", function() {
          var card = $(this).val();
          deck.remove(card).redraw();
          discards.add(card).redraw();
        });

        $(document).on("click", ".add-another-to-deck", function() {
          deck.add($(this).val()).redraw();
        });

        $(document).on("click", ".drawn-shortstack", function() {
          var card = $(this).val();
          shortstack.remove(card).redraw();
          discards.add(card).redraw();
        });

        var loadData = new URL(window.location.href).searchParams.get("loadData");

        if (loadData) {
          $("#game-data-to-load").val(loadData);
        }
      });
    </script>
  </head>

  <body>
    <div class="container">
      <div id="discarded-cards">
        <h1>Discarded Cards</h1>

        <div class="cards">
        </div>
      </div>

      <div id="shortstack-cards">
        <h1>Shortstack Cards</h1>

        <div class="cards">
        </div>
      </div>

      <div id="deck-cards">
        <h1>
          Deck
          <button class="btn btn-outline-primary when-unlocked" id="lock-deck" type="button"><span class="oi oi-lock-unlocked"></span></button>
          <button class="btn btn-outline-danger when-locked" id="unlock-deck" type="button"><span class="oi oi-lock-locked"></button>
        </h1>

        <div class="cards">
        </div>
      </div>

      <p>
        <div class="input-group when-unlocked">
          <input type="text" class="form-control" id="deck-card" placeholder="New Card" />
          <div class="input-group-append">
            <button class="btn btn-outline-primary" id="add-to-deck" type="button">Add</button>
          </div>
        </div>
      </p>

      <p>
        <div class="btn-group">
          <button class="btn btn-outline-danger" id="reset-game" type="button">Reset Game</button>
          <button class="btn btn-outline-danger" id="reset-everything" type="button">Reset EVERYTHING</button>
        </div>
      </p>

      <p>
        <button class="btn btn-outline-primary" id="create-load-link" type="button">Create Load Game Link</button>
        <div id="load-link"></div>
      </p>

      <p>
        <div class="input-group when-unlocked">
          <input type="text" class="form-control" id="game-data-to-load" placeholder="Game Data" />
          <div class="input-group-append">
            <button class="btn btn-outline-danger" id="load-data" type="button">Load</button>
          </div>
        </div>
      </p>
    </div>
  </body>
</html>
