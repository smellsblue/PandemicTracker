<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Pandemic Tracker</title>
    <script src="http://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>

    <script type="text/javascript">
      function LockStatus() {
        if (localStorage && localStorage.getItem("lockStatus") && localStorage.getItem("lockStatus") == "locked") {
          this.locked = true;
        } else {
          this.locked = false;
        }
      }

      LockStatus.prototype.lock = function() {
        this.locked = true;

        if (localStorage) {
          localStorage.setItem("lockStatus", "locked");
        }
      }

      LockStatus.prototype.unlock = function() {
        this.locked = false;

        if (localStorage) {
          localStorage.setItem("lockStatus", "unlocked");
        }
      }

      LockStatus.prototype.redraw = function() {
        if (this.locked) {
          $(".when-locked").show();
          $(".when-unlocked").hide();
        } else {
          $(".when-locked").hide();
          $(".when-unlocked").show();
        }
      }

      function CardStack(name, divId, template) {
        if (localStorage && localStorage.getItem(name)) {
          this.cards = localStorage.getItem(name).split(",");
        } else {
          this.cards = [];
        }

        this.name = name;
        this.divId = divId;
        this.template = template;
      }

      CardStack.prototype.save = function() {
        if (!localStorage) {
          return;
        }

        localStorage.setItem(this.name, this.cards.join(","));
      };

      CardStack.prototype.add = function(name) {
        this.cards.push(name);
        this.save();
        return this;
      };

      CardStack.prototype.addAll = function(names) {
        this.cards = this.cards.concat(names);
        this.save();
      };

      CardStack.prototype.remove = function(name) {
        var index = this.cards.indexOf(name);

        if (index < 0) {
          throw new Error("Cannot find card to remove: " + name);
        }

        this.cards.splice(index, 1);
        this.save();
        return this;
      };

      CardStack.prototype.moveTo = function(otherStack) {
        otherStack.addAll(this.cards);
        this.reset();
        return this;
      };

      CardStack.prototype.reset = function() {
        this.cards = [];
        this.save();
      };

      CardStack.prototype.$div = function() {
        return $("#" + this.divId);
      };

      CardStack.prototype.$cards = function() {
        return this.$div().find(".cards");
      };

      CardStack.prototype.redraw = function() {
        var $cards = this.$cards();
        $cards.empty();
        var template = this.template;

        this.eachSortedAndCounted(function(count, card) {
          $cards.append(template(count, card));
        });
      };

      CardStack.prototype.eachSortedAndCounted = function(fn) {
        var cards = this.cards.slice(0);
        cards.sort();

        while (cards.length > 0) {
          var size = 0;
          var card = cards[0];

          while (cards[0] == card) {
            size++;
            cards.splice(0, 1);
          }

          fn.call(null, size, card);
        }
      };

      CardStack.prototype.each = function(fn) {
        for (var i = 0; i < this.cards.length; i++) {
          fn(this.cards[i]);
        }
      };

      var discards = new CardStack("discards", "discarded-cards", function(count, name) {
        return '<div>' + count + ' x ' + name + '</div>';
      });

      var shortstack = new CardStack("shortstack", "shortstack-cards", function(count, name) {
        return '<div>' + count + ' x ' + name + ' <button class="drawn-shortstack" value="' + name + '">Drawn</button></div>';
      });

      var deck = new CardStack("deck", "deck-cards", function(count, name) {
        return '<div>' + count + ' x ' + name + ' <button class="when-unlocked add-another-to-deck" value="' + name + '">Add</button> <button class="draw-card" value="' + name + '">Draw</button> <button class="epidemic" value="' + name + '">Epidemic</button></div>';
      });

      var lockStatus = new LockStatus();

      function redrawAll() {
        discards.redraw();
        shortstack.redraw();
        deck.redraw();
        lockStatus.redraw();
      }

      $(function() {
        redrawAll();

        $("#lock-deck").click(function() {
          lockStatus.lock();
          lockStatus.redraw();
        });

        $("#unlock-deck").click(function() {
          lockStatus.unlock();
          lockStatus.redraw();
        });

        $("#reset-game").click(function() {
          if (confirm("Really reset the game?")) {
            discards.moveTo(deck);
            shortstack.moveTo(deck);
            redrawAll();
          }
        });

        $("#add-to-deck").click(function() {
          deck.add($("#deck-card").val()).redraw();
          $("#deck-card").val("");
        });

        $(document).on("click", ".epidemic", function() {
          var card = $(this).val();
          deck.remove(card).redraw();
          discards.add(card);
          discards.moveTo(shortstack).redraw();
          shortstack.redraw();
        });

        $(document).on("click", ".draw-card", function() {
          var card = $(this).val();
          deck.remove(card).redraw();
          discards.add(card).redraw();
        });

        $(document).on("click", ".add-another-to-deck", function() {
          deck.add($(this).val()).redraw();
        });

        $(document).on("click", ".drawn-shortstack", function() {
          var card = $(this).val();
          shortstack.remove(card).redraw();
          discards.add(card).redraw();
        });
      });
    </script>
  </head>

  <body>
    <div id="discarded-cards">
      <h1>Discarded Cards</h1>

      <div class="cards">
      </div>
    </div>

    <div id="shortstack-cards">
      <h1>Shortstack Cards</h1>

      <div class="cards">
      </div>
    </div>

    <div id="deck-cards">
      <h1>
        Deck
        <button class="when-unlocked" id="lock-deck">Lock</button>
        <button class="when-locked" id="unlock-deck">Unlock</button>
      </h1>

      <div class="cards">
      </div>
    </div>

    <div class="when-unlocked">
      <input type="text" id="deck-card" placeholder="New Card" />
      <button id="add-to-deck" type="button">Add</button>
    </div>

    <div>
      <button id="reset-game" type="button">Reset Game</button>
    </div>
  </body>
</html>
