<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Pandemic Tracker</title>
    <script src="http://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>

    <script type="text/javascript">
      function CardStack(name, divId, template) {
        this.cards = [];
        this.name = name;
        this.divId = divId;
        this.template = template;
      }

      CardStack.prototype.add = function(name) {
        this.cards.push(name);
        return this;
      };

      CardStack.prototype.remove = function(name) {
        var index = this.cards.indexOf(name);

        if (index < 0) {
          throw new Error("Cannot find card to remove: " + name);
        }

        this.cards.splice(index, 1);
        return this;
      };

      CardStack.prototype.moveTo = function(otherStack) {
        this.each(function(card) {
          otherStack.add(card);
        });

        this.reset();
        return this;
      };

      CardStack.prototype.reset = function() {
        this.cards = [];
      };

      CardStack.prototype.$div = function() {
        return $("#" + this.divId);
      };

      CardStack.prototype.$cards = function() {
        return this.$div().find(".cards");
      };

      CardStack.prototype.redraw = function() {
        var $cards = this.$cards();
        $cards.empty();
        var template = this.template;

        this.eachSortedAndCounted(function(count, card) {
          $cards.append(template(count, card));
        });
      };

      CardStack.prototype.eachSortedAndCounted = function(fn) {
        var cards = this.cards.slice(0);
        cards.sort();

        while (cards.length > 0) {
          var size = 0;
          var card = cards[0];

          while (cards[0] == card) {
            size++;
            cards.splice(0, 1);
          }

          fn.call(null, size, card);
        }
      };

      CardStack.prototype.each = function(fn) {
        for (var i = 0; i < this.cards.length; i++) {
          fn(this.cards[i]);
        }
      };

      var discards = new CardStack("discards", "discarded-cards", function(count, name) {
        return '<div>' + count + ' x ' + name + '</div>';
      });

      var shortstack = new CardStack("shortstack", "shortstack-cards", function(count, name) {
        return '<div>' + count + ' x ' + name + ' <button class="drawn-shortstack" value="' + name + '">Drawn</button></div>';
      });

      var deck = new CardStack("deck", "deck-cards", function(count, name) {
        return '<div>' + count + ' x ' + name + ' <button class="add-another-to-deck" value="' + name + '">Add</button> <button class="draw-card" value="' + name + '">Draw</button> <button class="epidemic" value="' + name + '">Epidemic</button></div>';
      });

      $(function() {
        $("#add-to-deck").click(function() {
          deck.add($("#deck-card").val()).redraw();
          $("#deck-card").val("");
        });

        $(document).on("click", ".epidemic", function() {
          var card = $(this).val();
          deck.remove(card).redraw();
          discards.add(card);
          discards.moveTo(shortstack).redraw();
          shortstack.redraw();
        });

        $(document).on("click", ".draw-card", function() {
          var card = $(this).val();
          deck.remove(card).redraw();
          discards.add(card).redraw();
        });

        $(document).on("click", ".add-another-to-deck", function() {
          deck.add($(this).val()).redraw();
        });

        $(document).on("click", ".drawn-shortstack", function() {
          var card = $(this).val();
          shortstack.remove(card).redraw();
          discards.add(card).redraw();
        });
      });
    </script>
  </head>

  <body>
    <div id="discarded-cards">
      <h1>Discarded Cards</h1>

      <div class="cards">
      </div>
    </div>

    <div id="shortstack-cards">
      <h1>Shortstack Cards</h1>

      <div class="cards">
      </div>
    </div>

    <div id="deck-cards">
      <h1>Deck</h1>

      <div class="cards">
      </div>
    </div>

    <div>
      <input type="text" id="deck-card" placeholder="New Card" />
      <button id="add-to-deck" type="button">Add</button>
    </div>
  </body>
</html>
